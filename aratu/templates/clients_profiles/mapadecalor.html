{% extends 'clients_profiles/base.html' %}

{% block title %}Mapa de Calor{% endblock %}

{% block content %}
<style>
  body {
    font-family: Arial, sans-serif;
  }
  #titulo {
    margin: 5px;
  }
</style>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
<body>
<h1 id="titulo">Air Quality Dashboard</h1>

<div>
  <h2>Importar Dados</h2>
  <button onclick="importData()">Importar Dados de Qualidade do Ar</button>
</div>

<div>
  <h2>Gerar Heatmap</h2>

  {% if perms.clients_profiles.view_airqualitydata %}
    <label for="pmType">Selecione o tipo de PM:</label>
    <fieldset id="pmType">
      <legend>Selecione o(s) tipo(s) de PM:</legend>
      <label><input type="checkbox" name="pmType" value="pm1m"> PM1.0 (Massa)</label><br>
      <label><input type="checkbox" name="pmType" value="pm25m"> PM2.5 (Massa)</label><br>
      <label><input type="checkbox" name="pmType" value="pm4m"> PM4.0 (Massa)</label><br>
      <label><input type="checkbox" name="pmType" value="pm10m"> PM10 (Massa)</label>
    </fieldset>


    <div class="form-group">
      <label for="start-date">Data de Início:</label>
      <input type="date" id="start-date" name="start-date" required disabled>
      <label for="end-date">Data de Fim:</label>
      <input type="date" id="end-date" name="end-date" required disabled>
    </div>
    <p>Intervalo de Datas: 
       <span id="min-date-display">—</span> até 
       <span id="max-date-display">—</span>
    </p>
    <button id="btn-heatmap" onclick="generateHeatmap()" disabled>
      Gerar Heatmap
    </button>
  {% else %}
    <p class="text-danger">
      Você não tem permissão para acessar o heatmap de qualidade do ar.
    </p>
  {% endif %}
  <button id="information-button" type="button">?</button>
  <div id="information-box" style="display: none; border: 2px solid #00000088; margin-top: 10px;">
    <p id="info-interface">Variáveis da Interface:</p>
    <ul id="info-variables">
      <li>Data de Início: define a data inicial do intervalo a ser analisado.</li>
      <li>Data de Fim: define a data final do intervalo a ser analisado.</li>
      <li>PM: representa o tipo de material particulado, classificado de acordo com a sua massa.</li>
    </ul>
  </div>
</div>

<div id="map-container" style="width:100%;height:600px;margin-top:20px;border:1px solid #ccc;">
  <!-- mapa será injetado aqui -->
</div>
</body>
<script>
  // estado do mapa
  let map = null;
  let rawData = [];
  let heatLayer = null;

  document.addEventListener('DOMContentLoaded', () => {
    const s = document.getElementById('start-date');
    const e = document.getElementById('end-date');
    const pm = document.getElementById('pmType');
    const btn = document.getElementById('btn-heatmap');
    const infoMin = document.getElementById('min-date-display');
    const infoMax = document.getElementById('max-date-display');
    const informationButton = document.getElementById('information-button');
    const informationBox = document.getElementById('information-box');

    const isValidRange = () => {
      if (!s.value || !e.value) return false;
      return new Date(s.value) <= new Date(e.value);
    };

    const toggleButton = () => {
      btn.disabled = !isValidRange();
    };

    async function fetchDateLimits() {
      try {
        const resp = await fetch('/date-limits/');
        if (!resp.ok) {
          // 403 (sem permissão) ou erro de rede
          throw new Error('Não foi possível obter os limites de data.');
        }
        const data = await resp.json();

        // limpa aviso anterior
        const prev = document.getElementById('no-dates-msg');
        if (prev) prev.remove();

        if (data.limites && data.start_date && data.end_date) {
          const start = new Date(data.start_date);
          const end   = new Date(data.end_date);
          const fmt = d => d.toISOString().slice(0, 10);

          // define min/max e valores iniciais
          s.min = fmt(start); s.max = fmt(end); s.value = fmt(start);
          e.min = fmt(start); e.max = fmt(end); e.value = fmt(end);

          infoMin.textContent = fmt(start);
          infoMax.textContent = fmt(end);

          s.disabled = e.disabled = false;
          toggleButton();
        } else {
          // sem dados: desabilita tudo e mostra aviso
          s.disabled = e.disabled = true;
          btn.disabled = true;
          infoMin.textContent = infoMax.textContent = '—';

          const aviso = document.createElement('p');
          aviso.id = 'no-dates-msg';
          aviso.textContent = 'Nenhuma data disponível para gerar heatmap.';
          aviso.style.color = 'red';
          infoMax.parentNode.appendChild(aviso);
        }
      } catch (err) {
        console.error(err);
        alert('Erro ao carregar limites de data.');
      }
    }

    // listeners de UI
    s.addEventListener('change', toggleButton);
    e.addEventListener('change', toggleButton);

    // ao trocar o tipo de PM, refaz a busca (precisa novo "value" do backend)
    pm.addEventListener('change', () => {
      if (isValidRange()) generateHeatmap();
    });

    // carrega limites assim que a página abre
    fetchDateLimits();

        // Exibe caixa de texto com explicações das variaveis
    informationButton.addEventListener('click', async () => {
      if (informationBox.style.display === 'none' || informationBox.style.display === '') {
        informationBox.style.display = 'block';
      } else {
        informationBox.style.display = 'none';
      }
    });
    
  });

  async function generateHeatmap() {
    const pmType = document.getElementById('pmType').value;
    const startDate = document.getElementById('start-date').value;
    const endDate   = document.getElementById('end-date').value;

    if (!startDate || !endDate || new Date(startDate) > new Date(endDate)) {
      alert('Verifique as datas selecionadas.');
      return;
    }

    const selectedTypes = Array.from(document.querySelectorAll('input[name="pmType"]:checked'))
        .map(cb => cb.value);

    if (selectedTypes.length === 0) {
        alert('Selecione pelo menos um tipo de PM.');
        return;
    }

    const pmParam = selectedTypes.join(',');
    const url = `/clients_profiles/generate-heatmap/?start_date=${startDate}&end_date=${endDate}&pm_type=${pmParam}`;

    try {
      const response = await fetch(url);
      const jsonData = await response.json();

      if (jsonData.error) {
        alert(jsonData.error);
        return;
      }
      rawData = jsonData.data;

      if (!map) {
        map = L.map('map-container').setView([-15.7942, -47.8822], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '© OpenStreetMap contributors'
        }).addTo(map);
      }

      updateHeatmapLayer();

      const bounds = rawData.map(p => [p.lat, p.lon]);
      if (bounds.length > 0) {
        map.fitBounds(bounds);
        setTimeout(() => map.invalidateSize(), 0);
      }
    } catch (error) {
      alert('Erro ao buscar os dados do mapa de calor: ' + error);
    }
  }

  function updateHeatmapLayer() {
    const heatData = rawData.map(p => [p.lat, p.lon, p.value]);
    if (heatLayer) {
      map.removeLayer(heatLayer);
    }
    heatLayer = L.heatLayer(heatData, { radius: 25 }).addTo(map);
  }

  function importData() {
    fetch('/sensor/import/')
      .then(r => r.json())
      .then(d => alert(d.message))
      .catch(e => alert('Erro na importação: ' + e));
  }
</script>


{% endblock %}