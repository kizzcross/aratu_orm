{% extends 'clients_profiles/base.html' %}

{% block title %}Previsão{% endblock %}

{% block content %}
<!DOCTYPE html>
<html>
<h1>Página de Previsão</h1>

<head>
    <!-- Inclui o token CSRF -->
    <meta name="csrf-token" content="{{ csrf_token }}">

    <script>
        async function fetchDateLimits() {
            try {
                const response = await fetch('/date-limits/');
                const data = await response.json();

                function formatDate(dateString) {
                    const date = new Date(dateString);
                    if (isNaN(date)) {
                        return ''; // Retorna string vazia se a data for inválida
                    }
                    const year = date.getFullYear();
                    const month = (date.getMonth() + 1).toString().padStart(2, '0');
                    const day = date.getDate().toString().padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }

                if (data.start_date && data.end_date) {
                    const startDate = formatDate(data.start_date);
                    const endDate = formatDate(data.end_date);

                    if (startDate && endDate) {
                        document.getElementById('start-date').min = startDate;
                        document.getElementById('start-date').max = endDate;
                        document.getElementById('end-date').min = startDate;
                        document.getElementById('end-date').max = endDate;

                        document.getElementById('min-date-display').textContent = startDate;
                        document.getElementById('max-date-display').textContent = endDate;
                    } else {
                        console.error('Data inválida recebida da API');
                    }
                }
            } catch (error) {
                console.error('Erro ao buscar limites de data:', error);
            }
        }

        // Função para obter o token CSRF
        function getCSRFToken() {
            return document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        }

        // Função para validar datas
        function isDateValid(dateString) {
            const date = new Date(dateString);
            return !isNaN(date);
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetchDateLimits();

            const startDateInput = document.getElementById('start-date');
            const endDateInput = document.getElementById('end-date');

            startDateInput.addEventListener('change', toggleClusterButton);
            endDateInput.addEventListener('change', toggleClusterButton);

            function toggleClusterButton() {
                const startDate = startDateInput.value;
                const endDate = endDateInput.value;
                const clusterButton = document.getElementById('generate-cluster');

                if (startDate && endDate && isDateValid(startDate) && isDateValid(endDate)) {
                    clusterButton.style.display = 'inline-block';
                } else {
                    clusterButton.style.display = 'none';
                }
            }

            // Função para enviar requisições com CSRF token
            async function sendRequest(url, method) {
                try {
                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCSRFToken() // Inclui o token CSRF
                        },
                    });
                    const data = await response.json();
                    return data;
                } catch (error) {
                    console.error('Erro ao enviar requisição:', error);
                }
            }

            // Eventos para os botões
            document.getElementById('generate-cluster').addEventListener('click', async () => {
                const data = await sendRequest('/clients_profiles/create-cluster/', 'POST');
                if (data) {
                    alert(data.message);
                    document.getElementById('define-regions').style.display = 'inline-block';
                }
            });

            document.getElementById('define-regions').addEventListener('click', async () => {
                const data = await sendRequest('/clients_profiles/define-regions/', 'POST');
                if (data) {
                    alert(data.message);
                    document.getElementById('train-model').style.display = 'inline-block';
                }
            });

            document.getElementById('train-model').addEventListener('click', async () => {
                const data = await sendRequest('/clients_profiles/train-model/', 'POST');
                if (data) {
                    alert(data.message);
                }
            });
        });
    </script>
</head>
<body>
    <form id="date-form" method="POST">
        <div id="start-date-display"></div>
        <div id="end-date-display"></div>
        <div class="form-group">
            <label for="start-date">Data de Início:</label>
            <input type="date" id="start-date" name="start-date" required>
            <label for="end-date">Data de Fim:</label>
            <input type="date" id="end-date" name="end-date" required>
        </div>
        <p>Intervalo de Datas: <span id="min-date-display"></span> até <span id="max-date-display"></span></p>
        <button id="generate-cluster" type="button" style="display: none;">Criar Cluster Geográfico</button>
        <button id="define-regions" type="button" style="display: none;">Definir Regiões</button>
        <button id="train-model" type="button" style="display: none;">Treinar Modelo</button>
    </form>
</body>
</html>
{% endblock %}
